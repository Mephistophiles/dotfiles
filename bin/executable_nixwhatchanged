#!/usr/bin/env julia
#
current_user = readchomp(`whoami`)

mktempdir() do path
	cd(path)

	update_report = nothing

	if current_user == "root"
		println("Run nixos-rebuild...")
		run(`nixos-rebuild build`)
		update_report = read(`nox-update --quiet /run/current-system result`, String)
	else
		println("Run home-manager...")
		run(`home-manager build --flake /etc/nixos`)
		update_report = read(`nox-update --quiet /nix/var/nix/profiles/per-user/mzhukov/home-manager result`, String)
	end


	if isempty(strip(update_report))
		println("System is up to date")
		return
	end

	println("---")

	if "-v" in ARGS
		print(update_report)
	else
		run(pipeline(IOBuffer(update_report),
		             `grep -v '\.drv : $'`,
		             `sed 's|^ */nix/store/[a-z0-9]*-||'`,
		             `sort -u`))
	end
end

