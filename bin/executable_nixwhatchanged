#!/usr/bin/env julia
#
current_user = readchomp(`whoami`)

mktempdir() do path
	cd(path)

	update_report = nothing

	if current_user == "root"
		println("Run nixos-rebuild...")
		run(`nixos-rebuild build`)
		update_report = read(`nix store diff-closures /run/current-system result/`, String)
	else
		println("Run home-manager...")
		run(`home-manager build --flake /etc/nixos`)
		update_report = read(`nix store diff-closures /nix/var/nix/profiles/per-user/mzhukov/home-manager result/`, String)
	end


	if isempty(strip(update_report))
		println("System is up to date")
		return
	end

	println("---")

	print(update_report)
end

