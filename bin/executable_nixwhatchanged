#!/usr/bin/env julia


mktempdir() do path
	cd(path)

	run(`nixos-rebuild build`)

	update_report = read(`nox-update --quiet /run/current-system result`, String)

	if isempty(strip(update_report))
		println("System is up to date")
		return
	end

	println("---")

	if "-v" in ARGS
		print(update_report)
	else
		run(pipeline(IOBuffer(update_report),
		             `grep -v '\.drv : $'`,
		             `sed 's|^ */nix/store/[a-z0-9]*-||'`,
		             `sort -u`))
	end
end

