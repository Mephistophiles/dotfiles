#!/usr/bin/env julia

function copy_nix_files(from, to, verbose=false, dry_run=false)
	args = [
		"rclone",
		"copy",
		"--config",
		"/dev/null",
		"--include",
		"*.nix",
		"$from/",
		"$to",
	]

	if verbose
		insert!(args, 2, "-v")
	end

	if dry_run
		insert!(args, 2, "--dry-run")
	end

	cmd = `$args`
	@debug("run $cmd")
	run(cmd)
end

uid = @ccall getuid()::Cint

search_place = "/etc/nixos/"

if uid != 0
	error("Invalid permissions: you must be root")
end

mktempdir() do before
	mktempdir() do after
		copy_nix_files(search_place, before)
		copy_nix_files(search_place, after)

		run(`nixpkgs-fmt $after`)

		status = run(ignorestatus(pipeline(`diff --recursive -U3 $before $after`, `delta --paging never`)))
		println("continue? ")

		try
			if lowercase(chomp(readline())) != "y"
				return
			end
		catch
			return
		end

		copy_nix_files(after, search_place, true)
	end
end
