#!/usr/bin/env julia

function copy_nix_files(from, to, dry_run=false)
	if dry_run
		run(`rsync --dry-run --archive --verbose --include='*/' --include='*.nix' --exclude='*' $from/ $to`)
	else
		run(`rsync --archive --verbose --include='*/' --include='*.nix' --exclude='*' $from/ $to`)
	end
end

uid = @ccall getuid()::Cint

search_place = "/etc/nixos/"

if uid != 0
	error("Invalid permissions: you must be root")
end

mktempdir() do before
	mktempdir() do after
		copy_nix_files(search_place, before)
		copy_nix_files(search_place, after)

		run(`nixpkgs-fmt $after`)

		status = run(ignorestatus(pipeline(`diff --recursive -U3 $before $after`, `delta --paging never`)))
		println("continue? ")

		try
			readline()
		catch
			return
		end

		copy_nix_files(after, search_place)
	end
end
